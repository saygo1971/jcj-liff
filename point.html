<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Point</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;margin:24px;line-height:1.6}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0}
    .muted{color:#666;font-size:12px}
    .ok{color:#0a7;font-weight:700}
    .ng{color:#c00;font-weight:700}
    .big{font-size:44px;font-weight:900;letter-spacing:1px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .card{flex:1;min-width:220px}
    pre{background:#f6f6f6;padding:12px;border-radius:10px;white-space:pre-wrap}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>JCJ Point</h2>
  <div id="status" class="muted">起動中…</div>

  <div class="row">
    <div class="card">
      <div class="muted">合計ポイント</div>
      <div id="total" class="big">--</div>
    </div>

    <div class="card">
      <div class="muted">内訳</div>
      <div id="breakdown">--</div>
    </div>
  </div>

  <div class="card">
    <div class="muted">最終チェックイン</div>
    <div id="last">--</div>
  </div>

  <div class="card">
    <div class="muted">デバッグ（必要な時だけ）</div>
    <button id="btnDebug">debug=1 で再取得</button>
    <pre id="debug"></pre>
  </div>

<script>
  // ★ここだけ設定
  const LIFF_ID = "2008851980-7muT3neQ"; // 既存のLIFFでも動くが、ポイント用に別LIFFを作るなら差し替え
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  const $ = (id)=>document.getElementById(id);

  function setStatus(ok, msg){
    $("status").innerHTML = `<span class="${ok?'ok':'ng'}">${msg}</span>`;
  }

  function fmtDate(d){
    if(!d) return "";
    // GASがDate文字列/数値を返す可能性があるので雑に対応
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return String(d);
    const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0"), dd=String(dt.getDate()).padStart(2,"0");
    const hh=String(dt.getHours()).padStart(2,"0"), mm=String(dt.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  }

  async function fetchPoint(userId, debug=false){
    const url = `${GAS_URL}?mode=point&userId=${encodeURIComponent(userId)}${debug?'&debug=1':''}`;
    const res = await fetch(url, { method:"GET" });
    const data = await res.json();
    if(!res.ok || !data || data.ok !== true){
      throw new Error(JSON.stringify(data || {status:res.status}));
    }
    return data;
  }

  async function main(debug=false){
    $("debug").textContent = "";
    setStatus(true, "起動中…");

    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()){
      // 外部ブラウザで開かれてる場合もあるので login で戻す
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId || "";
    if(!userId){
      setStatus(false, "userId が取得できません（LINE内で開いてください）");
      return;
    }

    setStatus(true, "取得中…");
    const data = await fetchPoint(userId, debug);

    // 表示
    $("total").textContent = String(data.totalPt ?? 0);

    const b = data.breakdown || {};
    $("breakdown").innerHTML =
      `店舗：${b.shopCount ?? 0}回 / ${b.shopPt ?? 0}pt<br>` +
      `イベント：${b.eventCount ?? 0}回 / ${b.eventPt ?? 0}pt`;

    const last = data.last || {};
    $("last").innerHTML =
      `更新：${fmtDate(last.updatedAt)}<br>` +
      `spot：${last.lastSpot || "-"}<br>` +
      `type：${last.lastType || "-"}`;

    setStatus(true, "完了");
    if(debug) $("debug").textContent = JSON.stringify(data, null, 2);
  }

  $("btnDebug").addEventListener("click", ()=>main(true));

  main(false).catch(err=>{
    setStatus(false, "エラー: " + (err?.message || String(err)));
    $("debug").textContent = (err?.stack || String(err));
  });
</script>
</body>
</html>
