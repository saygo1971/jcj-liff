<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Point</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;margin:18px}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:14px}
    .muted{color:#666;font-size:12px}
    .big{font-size:28px;font-weight:800;margin:8px 0}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .ng{color:#c00;font-weight:700}
    pre{background:#f6f6f6;padding:10px;border-radius:8px;white-space:pre-wrap}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="card">
    <div id="status" class="muted">起動中…</div>

    <div id="main" style="display:none;">
      <div class="muted">現在ポイント</div>
      <div id="total" class="big">-</div>

      <div class="row"><div>店舗チェックイン回数</div><div id="shopCount">-</div></div>
      <div class="row"><div>イベント回数</div><div id="eventCount">-</div></div>

      <div class="row"><div>最終チェックイン</div><div id="lastSpot">-</div></div>
      <div class="row"><div>更新日時</div><div id="updatedAt">-</div></div>

      <div style="margin-top:10px">
        <button id="refresh">更新</button>
      </div>
    </div>

    <pre id="debug" style="display:none;"></pre>
  </div>

<script>
  // ===== 設定ここだけ =====
  const LIFF_ID = "2008851980-7muT3neQ";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";
  // =======================

  const $ = id => document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const debugMode = (params.get("debug") || "") === "1";

  function setStatus(msg, ok=true){
    $("status").innerHTML = ok ? msg : `<span class="ng">${msg}</span>`;
  }
  function showDebug(obj){
    if(!debugMode) return;
    $("debug").style.display = "block";
    $("debug").textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2);
  }

  async function fetchPoint(userId){
    const url = `${GAS_URL}?mode=point&userId=${encodeURIComponent(userId)}&_=${Date.now()}`;
    const res = await fetch(url, { method:"GET" });
    const json = await res.json();
    return json;
  }

  function render(data){
    $("total").textContent = data.totalPt ?? 0;
    $("shopCount").textContent = data.breakdown?.shopCount ?? 0;
    $("eventCount").textContent = data.breakdown?.eventCount ?? 0;
    $("lastSpot").textContent = data.last?.lastSpot || "";
    $("updatedAt").textContent = data.last?.updatedAt || "";
    $("main").style.display = "block";
  }

  async function main(){
    setStatus("LIFF起動中…");
    await liff.init({ liffId: LIFF_ID });

    // LINE内で開く（重要：userId取得のため）
    if (!liff.isInClient()){
      setStatus("LINE内で開いてください（外部ブラウザだとポイント表示できません）", false);
      return;
    }

    if (!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId || "";
    if(!userId){
      setStatus("userIdが取得できませんでした", false);
      return;
    }

    setStatus("取得中…");
    const data = await fetchPoint(userId);

    showDebug({ userId, data });
    if(!data.ok){
      setStatus("取得失敗：" + (data.error || "unknown"), false);
      return;
    }

    setStatus("表示中");
    render(data);

    $("refresh").onclick = async ()=>{
      setStatus("更新中…");
      const d2 = await fetchPoint(userId);
      showDebug({ userId, d2 });
      if(d2.ok) { render(d2); setStatus("更新しました"); }
      else { setStatus("更新失敗：" + (d2.error || "unknown"), false); }
    };
  }

  main().catch(err=>{
    setStatus("エラー: " + (err?.message || String(err)), false);
    showDebug(err);
  });
</script>
</body>
</html>
