<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Check-in</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system; padding:16px; line-height:1.55}
    .title{font-size:20px;font-weight:700;margin:6px 0 10px}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;margin:10px 0}
    button{padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;width:100%;font-size:16px}
    .muted{color:#666;font-size:12px;word-break:break-all}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="title">JCJ チェックイン（テスト復旧版）</div>

  <div class="card">
    <div id="status">起動中…</div>
    <div class="muted" id="debug"></div>
  </div>

  <button id="btn" disabled>LINEにお礼を送る</button>

<script>
  const LIFF_ID = "2008851980-yhGytJRd";

  function getSpotFromAnyUrl() {
    // 1) 通常クエリ ?spot=
    const q = new URLSearchParams(location.search);
    const direct = q.get("spot");
    if (direct) return direct;

    // 2) LIFF が渡す liff.state の中に "?spot=xxx" が入るケース
    const stateRaw = q.get("liff.state");
    if (stateRaw) {
      // stateRawは既にデコード済み/未デコード両方ありえるので両対応
      const decoded = (() => {
        try { return decodeURIComponent(stateRaw); } catch(e) { return stateRaw; }
      })();
      const s = decoded.startsWith("?") ? decoded.slice(1) : decoded;
      const fromState = new URLSearchParams(s).get("spot");
      if (fromState) return fromState;
    }

    // 3) #?spot=xxx や #spot=xxx みたいにhashに来るケース
    if (location.hash) {
      const h = location.hash.replace(/^#\??/, ""); // "#?a=b" も "#a=b" も対応
      const fromHash = new URLSearchParams(h).get("spot");
      if (fromHash) return fromHash;
    }

    return null;
  }

  async function main() {
    await liff.init({ liffId: LIFF_ID });

    const spot = getSpotFromAnyUrl();

    const info =
      `LIFF OK / inClient=${liff.isInClient()} / loggedIn=${liff.isLoggedIn()} / spot=${spot ?? "NONE"}`;
    document.getElementById("status").textContent = info;

    // デバッグ表示（今どこからspotを取れてないか一発でわかる）
    const q = new URLSearchParams(location.search);
    document.getElementById("debug").innerHTML =
      `<div>href: <code>${location.href}</code></div>` +
      `<div>search: <code>${location.search || "(empty)"}</code></div>` +
      `<div>liff.state: <code>${q.get("liff.state") || "(none)"}</code></div>` +
      `<div>hash: <code>${location.hash || "(empty)"}</code></div>`;

    const btn = document.getElementById("btn");
    btn.disabled = !spot;

    btn.addEventListener("click", async () => {
      if (!spot) {
        alert("spotがありません");
        return;
      }
      if (!liff.isInClient()) {
        alert("LINE内で開いてください（inClient=false）");
        return;
      }
      try {
        await liff.sendMessages([{
          type: "text",
          text: `ありがとうございます！\nチェックイン：${spot}`
        }]);
        document.getElementById("status").textContent = `✅ 送信しました / spot=${spot}`;
      } catch (e) {
        document.getElementById("status").textContent =
          "❌ 送信失敗: " + (e?.message || JSON.stringify(e));
      }
    });
  }

  main().catch(e => {
    document.getElementById("status").textContent =
      "エラー: " + (e?.message || JSON.stringify(e));
  });
</script>
</body>
</html>
