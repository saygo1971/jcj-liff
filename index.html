<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Passport</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system; padding:16px; line-height:1.5}
    .title{font-size:22px; font-weight:700; margin:6px 0 10px}
    .muted{color:#666; font-size:13px}
    .card{border:1px solid #eee; border-radius:14px; padding:12px; margin:12px 0}
  </style>
</head>
<body>
  <div class="title" id="h">JCJ パスポート</div>
  <div class="card">
    <div class="muted" id="status">起動中…</div>
  </div>

<script>
  const LIFF_ID = "2008851980-yhGytJRd";

  // roasterID → 表示名（増やしていけばOK）
  const ROASTER_NAME = {
    "shizuoka_nomad": "静岡｜NOMAD"
  };

  function getRoaster(){
    const u = new URL(location.href);
    return u.searchParams.get("roaster");
  }

  function sentKey(roaster){
    return `jcj_sent_${roaster || "none"}`;
  }

  async function main(){
    await liff.init({ liffId: LIFF_ID });

    const roaster = getRoaster();
    const roasterLabel = roaster ? (ROASTER_NAME[roaster] || roaster) : null;

    document.getElementById("h").textContent = roasterLabel
      ? `チェックイン：${roasterLabel}`
      : "JCJ パスポート";

    // 二重送信防止（同じroasterは一度送ったら、次は送らない）
    // ※テスト中は下の行をコメントアウトすると毎回送れる
    if (roaster && localStorage.getItem(sentKey(roaster)) === "1") {
      document.getElementById("status").textContent = "✅ 受付済み（すでにチェックイン済み）";
      return;
    }

    // roaster が無い場合は何もしない（登録画面などに使える）
    if (!roasterLabel) {
      document.getElementById("status").textContent = "ロースター指定がないため送信しません。";
      return;
    }

    document.getElementById("status").textContent = "送信中…";

    try{
      await liff.sendMessages([{
        type:"text",
        text:`ありがとうございます！\n${roasterLabel} にチェックインしました。`
      }]);

      if (roaster) localStorage.setItem(sentKey(roaster), "1");
      document.getElementById("status").textContent = "✅ 送信しました！トークを見てね";
      // すぐ閉じたい場合（LINE内のみ有効）
      // if (liff.isInClient()) liff.closeWindow();
    }catch(e){
      document.getElementById("status").textContent = "❌ 送信失敗: " + (e?.message || JSON.stringify(e));
    }
  }

  main().catch(e=>{
    document.getElementById("status").textContent = "エラー: " + (e?.message || e);
  });
</script>
</body>
</html>
