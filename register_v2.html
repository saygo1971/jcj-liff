<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Passport 登録</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; padding: 16px; line-height: 1.6; background:#fff; }
    h1 { font-size: 22px; margin: 8px 0 12px; }
    .card { border: 1px solid #e6e6e6; border-radius: 14px; padding: 14px; margin: 12px 0; }
    label { display:block; margin: 10px 0 6px; font-weight: 700; }
    select, button { width: 100%; }
    select { padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; background: #fff; }
    .radio { margin: 10px 0; }
    .radio label { font-weight: 600; margin: 0; display:flex; align-items:center; gap:10px; }
    .radio input { transform: scale(1.1); }

    button{
      padding:14px; border-radius:14px; border:0;
      font-size:16px; font-weight:800; cursor:pointer;
      background:#06c755; color:#fff; margin-top:12px;
    }
    button:disabled{ background:#b7e8c7; opacity:1; cursor:not-allowed; }

    .muted { color:#666; font-size: 12px; }
    .ok { color:#0a7a25; font-weight: 800; }
    .ng { color:#b00020; font-weight: 800; }
    .msg { margin-top: 8px; }
  </style>
</head>

<body>
  <h1>JCJ パスポート登録</h1>

  <div class="card">
    <div class="muted">都道府県と好みを選んで登録してください</div>

    <label for="pref">お住まいの都道府県</label>
    <select id="pref">
      <option value="">選択してください</option>
      <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
      <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
      <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option><option>岐阜県</option><option>静岡県</option><option>愛知県</option>
      <option>三重県</option><option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
      <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
      <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
      <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
    </select>

    <label>好きな味</label>
    <div class="radio"><label><input type="radio" name="taste" value="FRUITY"> フルーティー（浅煎り）</label></div>
    <div class="radio"><label><input type="radio" name="taste" value="BALANCED"> バランス（中深煎り）</label></div>
    <div class="radio"><label><input type="radio" name="taste" value="BOLD"> コク（深煎り）</label></div>

    <button id="submit" disabled>登録する</button>
    <div id="status" class="msg muted" style="display:none;"></div>
  </div>

<script>
  const LIFF_ID = "2008851980-dSkB8ttU";
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  const elPref = document.getElementById("pref");
  const elBtn  = document.getElementById("submit");
  const elStatus = document.getElementById("status");

  function setStatus(text, ok=null) {
    elStatus.style.display = "block";
    if (ok === true) elStatus.innerHTML = `<span class="ok">✅</span> ${text}`;
    else if (ok === false) elStatus.innerHTML = `<span class="ng">❌</span> ${text}`;
    else elStatus.textContent = text;
  }
  function hideStatus() { elStatus.style.display="none"; elStatus.textContent=""; }

  function getTaste() {
    const r = document.querySelector('input[name="taste"]:checked');
    return r ? r.value : "";
  }
  function validate() {
    const pref = elPref.value.trim();
    const taste = getTaste();
    elBtn.disabled = !(pref && taste);
    if (elBtn.disabled) hideStatus();
  }
  elPref.addEventListener("change", validate);
  document.querySelectorAll('input[name="taste"]').forEach(r => r.addEventListener("change", validate));

  // JSONP（CORS回避）
  function callGASJsonp(paramsObj) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      paramsObj.callback = cbName;

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      const cleanup = () => {
        try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      };

      const qs = new URLSearchParams(paramsObj).toString();
      const script = document.createElement("script");
      script.src = `${GAS_ENDPOINT}?${qs}&_=${Date.now()}`;
      script.onerror = () => { cleanup(); reject(new Error("GAS request failed")); };
      document.body.appendChild(script);
    });
  }

  async function main() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    if (!liff.isInClient()) {
      setStatus("LINE内で開いてください。", false);
      elBtn.disabled = true;
      return;
    }

    hideStatus();
    validate();

    elBtn.addEventListener("click", async () => {
      const pref = elPref.value.trim();
      const taste = getTaste();
      if (!pref || !taste) { setStatus("都道府県と好みを選んでください。", false); return; }

      elBtn.disabled = true;
      setStatus("送信中…");

      try {
        const profile = await liff.getProfile();

        const data = await callGASJsonp({
          mode: "profile",
          userId: profile.userId,
          name: profile.displayName || "",
          pref: pref,
          taste: taste
        });

        if (!data || data.ok !== true) {
          throw new Error((data && data.error) ? data.error : "GAS error");
        }

        setStatus("登録しました！この画面は閉じてOKです。", true);

        await liff.sendMessages([{ type: "text", text: "JCJパスポート登録ありがとう！" }]);
        setTimeout(() => { try { liff.closeWindow(); } catch(e) {} }, 800);

      } catch (e) {
        setStatus("送信に失敗しました。GASのデプロイ設定（全員アクセス）とURLを確認してください。", false);
        console.log(e);
      } finally {
        elBtn.disabled = false;
      }
    });
  }

  main().catch(e => setStatus("起動エラー：" + (e?.message || String(e)), false));
</script>
</body>
</html>
