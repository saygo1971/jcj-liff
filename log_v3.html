<script>
const LIFF_ID = "2008851980-yhGytJRd";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

function getParam(name) {
  const u = new URL(location.href);
  return u.searchParams.get(name) || "";
}

async function main() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  const spot = getParam("spot").trim();
  const type = (getParam("type") || "shop").trim();   // shop/event
  const source = (getParam("source") || "nfc").trim();

  const profile = await liff.getProfile(); // ←ここが本物の userId

  const url = GAS_ENDPOINT + "?" + new URLSearchParams({
    spot,
    type,
    source,
    userId: profile.userId,
    name: profile.displayName || ""
  }).toString();

  const res = await fetch(url);
  const text = await res.text();
  document.body.innerText = text;
}

main().catch(e => document.body.innerText = "ERR: " + (e?.message || e));
</script>
