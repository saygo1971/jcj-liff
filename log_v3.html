<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCJ Check-in</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;margin:24px}
    .ok{color:#0a7} .ng{color:#c00} pre{background:#f6f6f6;padding:12px;border-radius:8px;white-space:pre-wrap}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>JCJ Check-in</h2>
  <div id="status">起動中…</div>
  <pre id="debug"></pre>

<script>
  // ★ここだけ設定
  const LIFF_ID  = "2008851980-yhGytJRd";
  const GAS_URL  = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  const $ = (id)=>document.getElementById(id);

  function setStatus(ok, msg){
    $("status").innerHTML = `<span class="${ok?'ok':'ng'}">${msg}</span>`;
  }
  function setDebug(obj){
    $("debug").textContent = typeof obj === "string" ? obj : JSON.stringify(obj,null,2);
  }

  // URLパラメータ：通常query or liff.state の両対応
  function getParams(){
    const p1 = new URLSearchParams(location.search);
    let spot = (p1.get("spot") || "").trim();
    let type = (p1.get("type") || "shop").trim();

    // LIFFが spot/type を liff.state に押し込むケース
    const st = (p1.get("liff.state") || "").trim();
    if ((!spot || !type) && st.startsWith("?")){
      const p2 = new URLSearchParams(st);
      spot = spot || (p2.get("spot") || "").trim();
      type = (type || p2.get("type") || "shop").trim();
    }
    return { spot, type, liffState: st || "(none)" };
  }

  // 二重送信防止（同spot/typeは10秒は送らない）
  function isRecentSubmit(spot, type){
    const key = `sent:${spot}:${type}`;
    const last = Number(sessionStorage.getItem(key) || 0);
    const now  = Date.now();
    if (now - last < 10000) return true;
    sessionStorage.setItem(key, String(now));
    return false;
  }

  async function main(){
    const { spot, type, liffState } = getParams();
    setDebug({href:location.href, spot, type, liffState});

    if (!spot){
      setStatus(false, "spotがありません（URLに ?spot=xxx&type=shop を付けてください）");
      return;
    }

    await liff.init({ liffId: LIFF_ID });

    // 外部ブラウザはここで止める（迷子防止）
    if (!liff.isInClient()){
      setStatus(false, "LINE内で開いてください（inClient=false）");
      return;
    }

    if (!liff.isLoggedIn()){
      liff.login();
      return;
    }

    if (isRecentSubmit(spot, type)){
      setStatus(true, "送信済み（連打防止）");
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId || "";
    const name   = profile.displayName || "";
    const source = "liff";

    // GASへ送信
    const url = `${GAS_URL}?spot=${encodeURIComponent(spot)}&type=${encodeURIComponent(type)}`
      + `&userId=${encodeURIComponent(userId)}&name=${encodeURIComponent(name)}&source=${encodeURIComponent(source)}`;

    const res  = await fetch(url, { method:"GET" });
    const text = await res.text();

    setStatus(true, "送信完了");
    setDebug({spot,type,userId,name,gasResult:text});

    setTimeout(()=>liff.closeWindow(), 900);
  }

  main().catch(err=>{
    setStatus(false, "エラー: " + (err && err.message ? err.message : String(err)));
    setDebug(err);
  });
</script>
</body>
</html>
