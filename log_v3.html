/***** 設定ここだけ埋める *****/
const SHEET_ID   = "19p3ncXe_XtKy-g2J8Eq-qFPLyBmUH4y6d4DdbMrzKVY"; // スプシID
const SHEET_LOG  = "checkin_log";   // チェックインログ
const SHEET_SPOT = "spots";         // 店舗マスタ
const SHEET_ACT  = "spots_action";  // 追加送信の定義
const SHEET_PROFILE = "profile";    // 住まい/好みの登録
const LINE_TOKEN = "4+mcx1NFmWXMYG+Dwl8rO2mkf8qSC0ULHr02HoKkFFrgqZOpjXXisTGwXrjvYuKpWiNrOkbZ5NHoLojbSC9zLkipxuDXvEcdAYUTE+SXGrTLHhfNaH+s3yOHrQMG0tY0e8rJ3SIxxoGZdWczefRi8wdB04t89/1O/w1cDnyilFU="; // Messaging API 長期トークン
/********************************/

function doGet(e) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const mode = (e.parameter.mode || "").trim().toLowerCase();

    // ===== プロフィール登録（register.html から）=====
    if (mode === "profile") {
      const userId = (e.parameter.userId || "").trim();
      const pref   = (e.parameter.pref || "").trim();
      const taste  = (e.parameter.taste || "").trim();
      const name   = (e.parameter.name || "").trim(); // displayName（任意）

      if (!userId) return text_("NG: userId required");
      if (!pref || !taste) return text_("NG: pref/taste required");

      upsertProfile_(ss, userId, pref, taste, name);
      return text_("OK_PROFILE");
    }

    // ===== チェックイン（log.html から）=====
    const spot   = (e.parameter.spot   || "").trim();
    const userId = (e.parameter.userId || "").trim();
    const name   = (e.parameter.name   || "").trim();
    const source = (e.parameter.source || "manual").trim();

    if (!spot) return text_("NG: spot required");

    // 1) ログ記録
    appendLog_(ss, spot, userId, name, source);

    // 2) 店名
    const shopName = getShopName_(ss, spot) || spot;

    // 3) 追加アクション
    const actions = getActionsForSpot_(ss, spot);

    // 4) 送信（userIdがある時だけ）
    if (userId) {
      const baseMsg = { type: "text", text: `チェックイン完了！\n${shopName}` };
      const extraMsgs = buildMessages_(actions, spot, shopName);
      pushMessages_(userId, [baseMsg, ...extraMsgs]);
    }

    return text_("OK");
  } catch (err) {
    return text_("ERROR: " + (err && err.message ? err.message : String(err)));
  }
}

/** ========== profile（userIdで上書き保存） ========== */
function upsertProfile_(ss, userId, pref, taste, displayName) {
  const sh = ss.getSheetByName(SHEET_PROFILE) || ss.insertSheet(SHEET_PROFILE);

  if (sh.getLastRow() === 0) {
    sh.appendRow(["TIMESTAMP","USER_ID","PREFECTURE","TASTE","DISPLAYNAME"]);
  }

  const last = sh.getLastRow();
  if (last === 1) {
    sh.appendRow([new Date(), userId, pref, taste, displayName || ""]);
    return;
  }

  // USER_ID列（B）を探す
  const ids = sh.getRange(2, 2, last - 1, 1).getValues(); // B2:B
  for (let i = 0; i < ids.length; i++) {
    if (String(ids[i][0] || "").trim() === userId) {
      const row = i + 2;
      // A:timestamp, C:pref, D:taste, E:displayName
      sh.getRange(row, 1, 1, 5).setValues([[new Date(), userId, pref, taste, displayName || ""]]);
      return;
    }
  }

  // 無ければ追加
  sh.appendRow([new Date(), userId, pref, taste, displayName || ""]);
}

/** ========== spots_action ========== */
function getActionsForSpot_(ss, spot) {
  const sh = ss.getSheetByName(SHEET_ACT);
  if (!sh) return [];

  const values = sh.getDataRange().getValues();
  if (values.length <= 1) return [];

  const out = [];
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const rSpot  = String(row[0] || "").trim();
    const type   = String(row[1] || "").trim().toLowerCase();
    const value  = String(row[2] || "").trim();
    const order  = Number(row[3] || 0);
    const active = String(row[4] || "").trim().toLowerCase();

    if (!rSpot || rSpot !== spot) continue;
    if (!type || !value) continue;
    if (!(active === "true" || active === "1" || active === "yes" || active === "on")) continue;

    out.push({ type, value, order: isNaN(order) ? 0 : order });
  }
  out.sort((a,b) => a.order - b.order);
  return out;
}

function buildMessages_(actions, spot, shopName) {
  const messages = [];

  actions.forEach(a => {
    if (a.type === "text") {
      const text = a.value.replaceAll("{spot}", spot).replaceAll("{shop}", shopName);
      messages.push({ type: "text", text });
    }
    if (a.type === "image") {
      if (/^https:\/\/.+/i.test(a.value)) {
        messages.push({
          type: "image",
          originalContentUrl: a.value,
          previewImageUrl: a.value
        });
      }
    }
    if (a.type === "url") {
      messages.push({ type: "text", text: a.value });
    }
  });

  return messages;
}

/** ========== spots（店名） ========== */
function getShopName_(ss, spot) {
  const sh = ss.getSheetByName(SHEET_SPOT);
  if (!sh) return "";

  const values = sh.getDataRange().getValues();
  if (values.length <= 1) return "";

  for (let i = 1; i < values.length; i++) {
    const rSpot = String(values[i][3] || "").trim(); // D列
    if (rSpot === spot) return String(values[i][2] || "").trim(); // C列
  }
  return "";
}

/** ========== log ========== */
function appendLog_(ss, spot, userId, name, source) {
  const sh = ss.getSheetByName(SHEET_LOG) || ss.insertSheet(SHEET_LOG);
  if (sh.getLastRow() === 0) sh.appendRow(["TIMESTAMP","SPOT","USER_ID","DISPLAYNAME","SOURCE"]);
  sh.appendRow([new Date(), spot, userId, name, source]);
}

/** ========== LINE push ========== */
function pushMessages_(userId, messages) {
  if (!userId) return;
  if (!LINE_TOKEN || LINE_TOKEN.includes("ここに")) throw new Error("LINE_TOKEN not set");

  for (let i = 0; i < messages.length; i += 5) {
    const chunk = messages.slice(i, i + 5);
    const payload = { to: userId, messages: chunk };

    const res = UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
      method: "post",
      contentType: "application/json",
      headers: { Authorization: "Bearer " + LINE_TOKEN },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });

    const code = res.getResponseCode();
    if (code < 200 || code >= 300) {
      throw new Error("LINE push failed: " + code + " / " + res.getContentText());
    }
  }
}

function text_(s) {
  return ContentService.createTextOutput(s).setMimeType(ContentService.MimeType.TEXT);
}
