<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JCJ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 18px; }
    .muted { color:#666; font-size: 13px; white-space: pre-wrap; word-break: break-all; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .btn { width: 100%; padding: 12px 14px; border-radius: 10px; border: 0; background: #06c755; color: #fff; font-size: 16px; }
  </style>
</head>
<body>
  <div class="card">
    <div id="status" class="muted">起動中…</div>
    <div id="debug" class="muted" style="display:none;"></div>
  </div>

  <div class="card" id="actionCard" style="display:none;">
    <button class="btn" id="openLineBtn">LINEで開く</button>
  </div>

<script>
  const LIFF_ID = "2008851980-yhGytJRd";

  // あなたのGAS WebアプリURL（/exec）
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");
  const actionCard = document.getElementById("actionCard");
  const openLineBtn = document.getElementById("openLineBtn");

  // ========== ルーティング（page=register は register.html へ） ==========
  (function routeByPage(){
    const q = new URLSearchParams(location.search);

    // 直接 page= がある
    const page = (q.get("page") || "").trim();
    if (page === "register") {
      // そのまま register.html へ（クエリは引き継がなくてOK）
      location.replace("./register.html");
      return;
    }

    // liff.state に page=register が入るケース
    const stateRaw = q.get("liff.state");
    if (stateRaw) {
      let decoded = stateRaw;
      try { decoded = decodeURIComponent(stateRaw); } catch(e) {}
      const s = decoded.startsWith("?") ? decoded.slice(1) : decoded;
      const page2 = (new URLSearchParams(s).get("page") || "").trim();
      if (page2 === "register") {
        location.replace("./register.html");
        return;
      }
    }
  })();

  // ========== spot 取得 ==========
  function getSpot() {
    const q = new URLSearchParams(location.search);

    // 1) 直接 spot=
    const direct = (q.get("spot") || "").trim();
    if (direct) return direct;

    // 2) liff.state 経由
    const stateRaw = q.get("liff.state");
    if (stateRaw) {
      let decoded = stateRaw;
      try { decoded = decodeURIComponent(stateRaw); } catch (e) {}
      const s = decoded.startsWith("?") ? decoded.slice(1) : decoded;
      return (new URLSearchParams(s).get("spot") || "").trim();
    }
    return "";
  }

  function setDebug(extra="") {
    // デバッグ出したい時は display:block にしてね
    debugEl.textContent =
`inClient=${liff.isInClient()} loggedIn=${liff.isLoggedIn()}
spot=${getSpot()}
href=${location.href}
search=${location.search}
${extra}`.trim();
  }

  function openInLine() {
    // LINEアプリ内で開き直す
    const spot = getSpot();
    const url = `line://app/${LIFF_ID}?spot=${encodeURIComponent(spot)}`;
    location.href = url;
  }

  // GASへ送信（画像ビーコンでOK）
  function sendToGAS(params) {
    const qs = new URLSearchParams(params).toString();
    const img = new Image();
    img.onload = () => {};
    img.onerror = () => {};
    img.src = `${GAS_WEBAPP_URL}?${qs}&_=${Date.now()}`;
  }

  async function main() {
    const spot = getSpot();
    if (!spot) {
      statusEl.textContent = "spotがありません（URLに ?spot=xxx が必要）";
      return;
    }

    await liff.init({ liffId: LIFF_ID });

    // LINE内で開かれていないなら、開き直しボタンを出す
    if (!liff.isInClient()) {
      statusEl.textContent = "外部ブラウザで開かれています。LINEで開いてください。";
      actionCard.style.display = "block";
      openLineBtn.onclick = openInLine;
      setDebug("NOT IN CLIENT");
      return;
    }

    // LINE内だけど未ログインならログイン
    if (!liff.isLoggedIn()) {
      statusEl.textContent = "ログイン中…";
      liff.login({ redirectUri: location.href });
      return;
    }

    statusEl.textContent = "チェックイン中…";

    const profile = await liff.getProfile();

    // GASへ送信（mode指定なし＝チェックイン処理に入る想定）
    sendToGAS({
      spot,
      userId: profile.userId || "",
      name: profile.displayName || "",
      source: "liff"
    });

    statusEl.textContent = "完了";

    // すぐ閉じる（LINE内のみ）
    setTimeout(() => {
      try { liff.closeWindow(); } catch(e) {}
    }, 450);

    setDebug("SENT");
  }

  main().catch(err => {
    statusEl.textContent = "エラー";
    // 一瞬出ても閉じたいなら、ここも閉じる
    setTimeout(() => { try { liff.closeWindow(); } catch(e) {} }, 800);
    debugEl.style.display = "block";
    debugEl.textContent = "ERROR: " + (err?.message || String(err));
  });
</script>
</body>
</html>
