<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JCJ Log</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 20px; }
    .muted { color: #666; font-size: 13px; white-space: pre-wrap; word-break: break-all; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .btn { width: 100%; padding: 12px 14px; border-radius: 10px; border: 0; background: #06c755; color: #fff; font-size: 16px; }
  </style>
</head>
<body>
  <div class="card">
    <div id="status" class="muted">起動中…</div>
    <div id="debug" class="muted" style="display:none;"></div>
  </div>

  <div class="card" id="actionCard" style="display:none;">
    <button class="btn" id="openLineBtn">LINEで開く</button>
  </div>

<script>
  const LIFF_ID = "2008851980-yhGytJRd";
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  function getSpot() {
    const q = new URLSearchParams(location.search);
    const direct = (q.get("spot") || "").trim();
    if (direct) return direct;

    const stateRaw = q.get("liff.state");
    if (stateRaw) {
      let decoded = stateRaw;
      try { decoded = decodeURIComponent(stateRaw); } catch (e) {}
      const s = decoded.startsWith("?") ? decoded.slice(1) : decoded;
      return (new URLSearchParams(s).get("spot") || "").trim();
    }
    return "";
  }

  function openInLine(spot) {
    location.href = `line://app/${LIFF_ID}?spot=${encodeURIComponent(spot)}`;
  }

  function sendToGAS(params) {
    const qs = new URLSearchParams(params).toString();
    const img = new Image();
    img.src = `${GAS_WEBAPP_URL}?${qs}&_=${Date.now()}`;
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function safeClose() {
    // closeWindowはLINE内でのみ動く。失敗しても落ちないように握りつぶす
    try { liff.closeWindow(); } catch(e) {}
  }

  async function main() {
    const status = document.getElementById("status");
    const actionCard = document.getElementById("actionCard");
    const openLineBtn = document.getElementById("openLineBtn");

    const spot = getSpot();
    if (!spot) { status.textContent = "spotがありません"; return; }

    await liff.init({ liffId: LIFF_ID });

    if (!liff.isInClient()) {
      status.textContent = "外部ブラウザです。LINEで開いてください。";
      actionCard.style.display = "block";
      openLineBtn.onclick = () => openInLine(spot);
      return;
    }

    if (!liff.isLoggedIn()) {
      status.textContent = "LINEログイン中…";
      liff.login({ redirectUri: location.href });
      return;
    }

    // ここまで来たら userId 取れる
    status.textContent = "チェックイン中…";
    const profile = await liff.getProfile();

    // ログ送信（GAS→スプシ） ※LINEへのメッセージはGAS側がPushする
    sendToGAS({
      spot,
      userId: profile.userId || "",
      name: profile.displayName || "",
      source: "liff"
    });

    // 送信が飛ぶのを少し待ってから閉じる（完了画面を見せない）
    await sleep(250);
    await safeClose();
    return;
  }

  main().catch(async (err) => {
    // どんなエラーでも閉じる（ユーザーに見せない）
    try {
      await sleep(200);
      await safeClose();
    } catch(e) {}
  });
</script>
</body>
</html>
