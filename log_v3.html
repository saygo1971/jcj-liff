<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JCJ Log</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ここがポイント：最初から何も描画しない */
    body { display:none; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }

    /* エラー時だけ表示する簡易UI */
    .wrap { padding:16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:14px; }
    .muted { color:#666; font-size:13px; white-space:pre-wrap; word-break:break-all; }
    .btn { width:100%; padding:12px 14px; border-radius:10px; border:0; background:#06c755; color:#fff; font-size:16px; }
  </style>
</head>
<body>
  <!-- 通常は一切出さない。エラー/外部ブラウザ時だけ出す -->
  <div class="wrap" id="fallback" style="display:none;">
    <div class="card">
      <div id="msg" class="muted"></div>
      <div id="dbg" class="muted" style="margin-top:10px;"></div>
    </div>
    <div class="card" id="openLineCard" style="display:none; margin-top:12px;">
      <button class="btn" id="openLineBtn">LINEで開く</button>
    </div>
  </div>

<script>
  const LIFF_ID = "2008851980-yhGytJRd";
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzGK5iAQ3RpnzVISfB79BaOlodiMrqEGcGtbxbk5aS1xJuC7QqgGDtVukAq4vZING0GXQ/exec";

  function getSpot() {
    const q = new URLSearchParams(location.search);
    const direct = (q.get("spot") || "").trim();
    if (direct) return direct;

    const stateRaw = q.get("liff.state");
    if (stateRaw) {
      let decoded = stateRaw;
      try { decoded = decodeURIComponent(stateRaw); } catch (e) {}
      const s = decoded.startsWith("?") ? decoded.slice(1) : decoded;
      return (new URLSearchParams(s).get("spot") || "").trim();
    }
    return "";
  }

  function openInLine(spot) {
    location.href = `line://app/${LIFF_ID}?spot=${encodeURIComponent(spot)}`;
  }

  function sendToGAS(params) {
    const qs = new URLSearchParams(params).toString();
    const img = new Image();
    img.src = `${GAS_WEBAPP_URL}?${qs}&_=${Date.now()}`;
  }

  function showFallback(message, extra = "", showOpenLine = false, spot = "") {
    document.body.style.display = "block";
    const fb = document.getElementById("fallback");
    fb.style.display = "block";

    document.getElementById("msg").textContent = message;
    document.getElementById("dbg").textContent =
`href: ${location.href}
search: ${location.search}
${extra}`.trim();

    const card = document.getElementById("openLineCard");
    const btn = document.getElementById("openLineBtn");
    if (showOpenLine) {
      card.style.display = "block";
      btn.onclick = () => openInLine(spot);
    } else {
      card.style.display = "none";
      btn.onclick = null;
    }
  }

  async function main() {
    const spot = getSpot();
    if (!spot) {
      showFallback("spotがありません（URLに ?spot=xxx が必要）");
      return;
    }

    await liff.init({ liffId: LIFF_ID });

    // 外部ブラウザなら案内だけ出す（ここだけ表示）
    if (!liff.isInClient()) {
      showFallback("LINE内で開いてください（外部ブラウザでは動きません）", "inClient=false", true, spot);
      return;
    }

    // 未ログインならログイン（この時も表示しない）
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();

    // 1) スプシに記録
    sendToGAS({
      spot,
      userId: profile.userId || "",
      name: profile.displayName || "",
      source: "liff"
    });

    // 2) LINEに1通送る（失敗しても閉じる）
    try {
      await liff.sendMessages([{
        type: "text",
        text: `チェックイン完了！\nSPOT: ${spot}\nNAME: ${profile.displayName || ""}`
      }]);
    } catch (e) {
      // 送信失敗でも運用上は閉じる（必要ならここでfallback表示に変える）
    }

    // 3) 即クローズ（表示なし）
    liff.closeWindow();
  }

  main().catch(err => {
    const spot = getSpot();
    showFallback("エラー: " + (err?.message || String(err)),
      `inClient=${(typeof liff !== "undefined" && liff.isInClient) ? liff.isInClient() : "?"}
loggedIn=${(typeof liff !== "undefined" && liff.isLoggedIn) ? liff.isLoggedIn() : "?"}
spot=${spot}`, false, spot);
  });
</script>
</body>
</html>
